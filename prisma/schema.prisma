// This is your Prisma schema file,

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url     = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      Role     @default(MERCHANT)
  isActive  Boolean  @default(true)
  invitedBy String?
  joinedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inviteToken         String?   @unique
  inviteTokenExpiry   DateTime?

  // Two-factor authentication fields
  twoFactorEnabled    Boolean  @default(false)
  twoFactorSecret     String?

  merchant      Merchant?
  preferences   UserPreferences?
  activityLogs  ActivityLog[]
  sentMessages  Message[]

  assignedConversations   Conversation[]  @relation("AssignedConversations")

  broadcasts Broadcast[]  
  broadcastTemplates BroadcastTemplate[] 
  segments Segment[]  

  rider       Rider?

  @@map("users")
}

model Merchant {
  id                   String             @id @default(cuid())
  userId               String             @unique
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade) 
  businessName         String
  category             String
  location             String
  phone                String
  profilePictureUrl    String?
  verificationStatus   VerificationStatus @default(PENDING)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  verification         MerchantVerification?

  products             Product[]
  orders               Order[]
  wallet               MerchantWallet?

  @@map("merchants")
}

model MerchantVerification {
  id                    String             @id @default(cuid())
  merchantId            String             @unique
  merchant              Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  governmentIdUrl       String
  businessLicenseUrl    String?
  productSampleUrl      String
  businessAddress       String
  registrationNumber    String?
  
  status                VerificationStatus @default(PENDING)
  
  idVerificationStatus       VerificationStatus @default(PENDING)
  locationVerificationStatus VerificationStatus @default(PENDING)
  productSampleStatus        VerificationStatus @default(PENDING)
  
  businessLicenseStatus      VerificationStatus?
  registrationNumberStatus   VerificationStatus?
  
  idVerifiedAt               DateTime?
  locationVerifiedAt         DateTime?
  productSampleVerifiedAt    DateTime?
  businessLicenseVerifiedAt  DateTime?
  registrationNumberVerifiedAt DateTime?
  
  idRejectionReason          String?
  locationRejectionReason    String?
  productRejectionReason     String?
  businessLicenseRejectionReason String?
  registrationNumberRejectionReason String?
  
  rejectionReason       String?
  submittedAt           DateTime           @default(now())
  reviewedAt            DateTime?
  reviewedBy            String?
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  @@map("merchant_verifications")
}

model Product {
  id              String            @id @default(cuid())
  merchantId      String
  merchant        Merchant          @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  name            String
  description     String
  category        String
  price           Float
  stockQuantity   Int
  unit            String
  minOrderQty     Int
  
  images          String[]
  variants        Json?

  markup          Float? @default(0)
  retailPrice     Float?
  
  approvalStatus  ApprovalStatus    @default(PENDING)
  rejectionReason String?
  isActive        Boolean           @default(true)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  whatsappProductId       String?
  whatsappSyncStatus      SyncStatus @default(NOT_SYNCED)
  lastSyncedAt            DateTime?

  orderItems            OrderItem[]
  customerOrderItems    CustomerOrderItem[]    @relation("ProductToCustomerOrderItem")
  cartItems             CartItem[]               @relation("ProductToCartItem")

  @@map("products")
}

model Order {
  id              String        @id @default(cuid())
  merchantId      String
  merchant        Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  orderItems      OrderItem[]
  
  totalAmount     Float
  status          OrderStatus   @default(PENDING)
  pickupTime      DateTime
  orderNotes      String?
  rejectionReason String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  customer Customer @relation(fields: [customerId], references: [id])
  customerId String

  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  quantity    Int
  price       Float
  
  createdAt   DateTime @default(now())

  @@map("order_items")
}

model StockUpdateNotification {
  id          String   @id @default(cuid())
  merchantId  String
  productId   String
  productName String
  oldStock    Int
  newStock    Int
  isRecieved  Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@map("stock_update_notifications")
}

model UserPreferences {
  id                  String  @id @default(cuid())
  userId              String  @unique
  user                User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  emailNotifications  Boolean @default(true)
  pushNotifications   Boolean @default(false)
  // theme               String  @default("light")
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("user_preferences")
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action      String
  description String?
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())

  @@map("activity_logs")
  @@index([userId, createdAt])
}

model CustomerMessage {
  id              String    @id @default(cuid())
  messageId       String    @unique //whatsapp message 
  from            String    // customer phone number
  message         String    @db.Text
  timestamp       DateTime  @default(now())
  isRead          Boolean   @default(false)
  createdAt       DateTime  @default(now())

  @@map("customer_message")
}

model CustomerOrder {
  id              String              @id @default(cuid())
  orderNumber     String              @unique
  customerPhone   String
  customerName    String?
  customerEmail   String?             // Add email for Paystack
  merchantId      String
  totalAmount     Float
  status          CustomerOrderStatus @default(PENDING)
  paymentStatus   PaymentStatus       @default(PENDING)
  paymentReference String?            @unique // Paystack reference
  paymentProof    String?
  items           CustomerOrderItem[]
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  emailCollectionStatus String? // 'PENDING', 'COLLECTED', 'SKIPPED'
  pendingEmailCollection Boolean @default(false)

  invoice         Invoice?
  paymentExpiresAt    DateTime?

  refundStatus        RefundStatus   @default(NONE)
  refundReason        String?
  refundRequestedAt   DateTime?
  refundAmount        Float?
  refundedAt          DateTime?
  refundNotes         String?

  escrow              Escrow?
  payouts             Payout[]
  delivery            Delivery?
  
  @@map("customer_orders")
}

model CustomerOrderItem {
  id              String        @id @default(cuid())
  orderId         String
  order           CustomerOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId       String
  product         Product       @relation("ProductToCustomerOrderItem", fields: [productId], references: [id])
  quantity        Int
  price           Float
  
  @@map("customer_order_items")
}

model Cart {
  id            String    @id @default(cuid())
  customerPhone String
  items         CartItem[]
  status        CartStatus    @default(ACTIVE)
  expiresAt     DateTime   // Auto Expires after ceratin time
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("carts")
  @@index([customerPhone, status])
}

model CartItem {
  id          String   @id @default(cuid())
  cartId      String
  cart        Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation("ProductToCartItem", fields: [productId], references: [id])
  quantity    Int
  addedAt     DateTime @default(now())
  
  @@map("cart_items")
}

model Invoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique
  orderId         String   @unique
  order           CustomerOrder @relation(fields: [orderId], references: [id])
  pdfUrl          String?
  createdAt       DateTime @default(now())
}

model Conversation {
  id                String @id @default(cuid())
  customerPhone     String // Masked version: +234801****78
  customerPhoneHash String @unique // Hashed for searching
  customerName      String?
  lastMessage       String? @default("[Encrypted]")
  lastMessageAt     DateTime @default(now())
  unreadCount       Int @default(0)
  status            String @default("active") // active, resolved, archived
  tags              String[] @default([])
  assignedTo        String? // User ID
  assignedAdmin     User? @relation("AssignedConversations", fields: [assignedTo], references: [id])
  messages          Message[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id])
  customerId String

  @@index([status])
  @@index([assignedTo])
  @@index([lastMessageAt])
  @@index([customerPhoneHash])
}

model Message {
  id                  String @id @default(cuid())
  conversationId      String
  conversation        Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId            String? // User ID for admin messages
  sender              User? @relation(fields: [senderId], references: [id])
  senderType          String // customer, admin, bot
  content             String @default("[Encrypted]") // Placeholder text
  
  // Encryption fields
  encryptedContent        String? @db.Text
  encryptionIv            String?
  encryptionAuthTag       String?
  messageHash             String? @unique // For deduplication
  
  messageType             String @default("text") // text, image, document, interactive, template
  whatsappMessageId       String? @unique
  status                  String @default("sent") // sent, delivered, read, failed
  metadata                Json?
  createdAt               DateTime @default(now())

  @@index([conversationId, createdAt])
  @@index([senderType])
  @@index([whatsappMessageId])
  @@index([status])
  @@index([messageHash])
}

model Escrow {
  id              String        @id @default(cuid())
  orderId         String        @unique
  order           CustomerOrder @relation(fields: [orderId], references: [id])
  merchantId      String
  amount          Float
  status          EscrowStatus  @default(HELD)
  heldAt          DateTime      @default(now())
  releasedAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("escrow")
  @@index([merchantId, status])
}

model Payout {
  id              String        @id @default(cuid())
  merchantId      String
  orderId         String
  order           CustomerOrder @relation(fields: [orderId], references: [id])
  amount          Float
  status          PayoutStatus  @default(PENDING)
  availableAt     DateTime      @default(now())
  paidOutAt       DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("payouts")
  @@index([merchantId, status])
}

model Customer {  
  id                String @id @default(cuid())    
  
  whatsappId        String? @unique  
  phone             String @unique  
  phoneHash         String @unique  
  profileName       String?  
  profilePicture    String?    
  
  // Contact Info  
  name              String?  
  email             String? @unique  
  country           String? @default("NG")  
  city              String?  
  state             String?  
  address           String?  
  gender            String? @default("unknown")  
  dateOfBirth       DateTime?    
  
  // Business Info (if they're a business)  
  isBusiness          Boolean @default(false)  
  businessName        String?  
  businessCategory    String?  
  businessAddress     String?  
  businessEmail       String?  
  businessWebsite     String?    
  
  // Customer Metrics  
  totalOrders       Int @default(0)  
  totalSpent        Decimal @default(0)  
  avgOrderValue     Decimal @default(0)  
  lastOrderDate     DateTime?  
  firstOrderDate    DateTime?  
  orderCount30Days  Int @default(0)  
  spent30Days       Decimal @default(0)    
  
  // WhatsApp Stats  
  totalMessages           Int @default(0)  
  incomingMessages        Int @default(0)  
  outgoingMessages        Int @default(0)  
  lastMessageDate         DateTime?  
  firstMessageDate        DateTime?  
  messageCount30Days      Int @default(0)  
  responseTimeAvg         Int? // Average response time in seconds    

  // Customer Status & Classification  
  status                CustomerStatus @default(ACTIVE)  
  customerType          CustomerType @default(REGULAR)  
  customerTier          CustomerTier @default(BRONZE)  
  loyaltyPoints         Int @default(0)    
  
  // Tags & Metadata  
  tags        String[] @default([])  
  source      String @default("whatsapp")  
  notes       String?    
  
  // Preferences 
  whatsappOptIn       Boolean @default(true)  
  marketingOptIn      Boolean @default(false)  
  emailOptIn          Boolean @default(false)  
  language            String @default("en")    
   
  // Contact Status  
  isBlocked         Boolean @default(false)  
  isArchived        Boolean @default(false)  
  lastActive        DateTime @default(now())    
  
  // Relationships  
  conversations     Conversation[]  
  orders            Order[]  
  notesHistory      CustomerNote[]  
  activities        CustomerActivity[]    
  
  // Timestamps  
  createdAt         DateTime @default(now())  
  updatedAt         DateTime @updatedAt  
  lastSynced        DateTime? // Last sync with WhatsApp  
  
  broadcastRecipients BroadcastRecipient[]  
  
  @@map("customers")  
  @@index([phone])  
  @@index([email])  
  @@index([status])  
  @@index([customerType])  
  @@index([customerTier])  
  @@index([totalSpent])  
  @@index([lastActive])  
  @@index([createdAt])

}

model CustomerNote {  
  id                  String @id @default(cuid())  
  customerId          String  
  customer            Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)  
  note                String  
  createdBy           String // Admin ID or system  
  createdAt           DateTime @default(now())  
  updatedAt           DateTime @updatedAt    
  
  @@map("customer_notes")  
  @@index([customerId])
}

model CustomerActivity {  
  id              String @id @default(cuid())  
  customerId      String  
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)  
  activity        String // 'message_sent', 'order_placed', 'profile_updated', etc.  
  description     String?  
  metadata        Json?  
  createdAt       DateTime @default(now())    
  
  @@map("customer_activities")  
  @@index([customerId])  
  @@index([activity])  
  @@index([createdAt])
}

model MerchantWallet {
  id              String              @id @default(cuid())
  merchantId      String              @unique
  merchant        Merchant            @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  balance         Float               @default(0)
  totalEarnings   Float               @default(0)
  totalWithdrawals Float              @default(0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  transactions    WalletTransaction[]

  @@map("merchant_wallets")
}

model WalletTransaction {
  id              String        @id @default(cuid())
  walletId        String
  wallet          MerchantWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  type            TransactionType
  amount          Float
  balanceAfter    Float
  orderId         String?
  reference       String        @unique
  description     String
  createdAt       DateTime      @default(now())

  @@map("wallet_transactions")
  @@index([walletId, createdAt])
}

model PlatformWallet {
  id                  String   @id @default(cuid())
  totalRevenue        Float    @default(0)
  totalPayouts        Float    @default(0)
  currentBalance      Float    @default(0)
  updatedAt           DateTime @updatedAt

  @@map("platform_wallet")
}

model Broadcast {
  id String @id @default(cuid())
  name String
  description String?
  
  content String 
  templateId String? 
  
  segmentId String?
  customFilter Json? 
  
  totalRecipients Int @default(0)
  successfulSends Int @default(0)
  failedSends Int @default(0)
  
  scheduledFor DateTime?
  sentAt DateTime? 
  
  status BroadcastStatus @default(DRAFT)
  approvalStatus ApprovalStatus @default(PENDING)
  
  whatsappTemplateName String? 
  whatsappTemplateId String? 
  
  createdBy String
  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  
  segment Segment? @relation(fields: [segmentId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  openRate Float? @default(0)
  clickRate Float? @default(0)
  conversionRate Float? @default(0)

  recipients BroadcastRecipient[]
  
  @@index([createdBy])
  @@index([segmentId])
  @@index([status])
  @@index([approvalStatus])
  @@index([scheduledFor])
}

model BroadcastTemplate {
  id String @id @default(cuid())
  name String
  description String?
  category TemplateCategory @default(PROMOTION)
  
  header String? 
  body String 
  footer String? 
  
  variables String[] 
  
  approvalStatus ApprovalStatus @default(PENDING)
  rejectionReason String? 
  
  whatsappTemplateId String? 
  whatsappTemplateName String? 
  languageCode String @default("en_US")
  
  sampleData Json? 

  createdBy String
  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  
  submittedAt DateTime? 
  approvedAt DateTime? 
  rejectedAt DateTime? 
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usedCount Int @default(0)
  lastUsed DateTime?
  
  @@index([createdBy])
  @@index([approvalStatus])
  @@index([category])
}

model BroadcastRecipient {
  id String @id @default(cuid())
  
  broadcastId String 
  broadcast Broadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)
  
  customerPhone String // Hashed phone number
  customer Customer? @relation(fields: [customerPhone], references: [phoneHash], onDelete: SetNull)

  status RecipientStatus @default(PENDING)
  whatsappMessageId String? 
  
  sentAt DateTime?
  deliveredAt DateTime?
  readAt DateTime?
  failedAt DateTime?
  failureReason String?
  
  opened Boolean @default(false)
  clicked Boolean @default(false)
  converted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([broadcastId, customerPhone])
  @@index([broadcastId])
  @@index([customerPhone])
  @@index([status])
}

model Segment {
  id String @id @default(cuid())
  name String @unique
  description String?
  criteria Json // Segment criteria
  tags String[]
  color String @default("purple")
  customerCount Int @default(0)
  purchaseBehavior Json? // Behavioral data
  
  // Relationships
  createdBy User @relation(fields: [createdById], references: [id])
  createdById String
  broadcasts Broadcast[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isDeleted Boolean @default(false)
}

model Rider {
  id                String       @id @default(cuid())
  userId            String       @unique
  user              User         @relation(fields: [userId], references: [id])
  
  firstName         String
  lastName          String
  phone             String       @unique
  email             String       @unique
  
  vehicleType       String
  vehicleNumber     String?
  licensePlate      String?
  
  status            RiderStatus  @default(OFFLINE)
  currentLatitude   Float?
  currentLongitude  Float?
  
  rating            Float        @default(0)
  totalDeliveries   Int          @default(0)
  
  deliveries        Delivery[]
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  @@map("riders")
}

model Delivery {
  id                String          @id @default(cuid())
  deliveryNumber    String          @unique
  
  orderId           String          @unique
  order             CustomerOrder   @relation(fields: [orderId], references: [id])
  
  provider          DeliveryProvider
  riderId           String?
  rider             Rider?          @relation(fields: [riderId], references: [id])
  
  status            DeliveryStatus  @default(PENDING)
  pickupAddress     String
  pickupLatitude    Float
  pickupLongitude   Float
  deliveryAddress   String
  deliveryLatitude  Float
  deliveryLongitude Float
  
  recipientName     String
  recipientPhone    String
  
  proofOfDeliveryImage String?
  deliveryNotes     String?
  
  assignedAt        DateTime?
  pickedUpAt        DateTime?
  deliveredAt       DateTime?
  
  deliveryFee       Float?
  
  events            DeliveryEvent[]
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@map("deliveries")
}

model DeliveryEvent {
  id          String          @id @default(cuid())
  deliveryId  String
  delivery    Delivery        @relation(fields: [deliveryId], references: [id])
  
  status      DeliveryStatus
  description String?
  
  createdAt   DateTime        @default(now())
  
  @@map("delivery_events")
}

enum Role {
  ADMIN
  MERCHANT
  MANAGER
  SUPPORT
  RIDER
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  PENDING
  ACCEPTED
  READY
  COMPLETED
  REJECTED
}

enum SyncStatus {
  NOT_SYNCED
  SYNCED
  FAILED
}

enum CustomerOrderStatus {
  PENDING
  PAYMENT_PENDING
  PAID 
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum CartStatus {
  ACTIVE
  ABANDONED
  CONVERTED
  EXPIRED
}

enum RefundStatus {
  NONE 
  REQUESTED
  APPROVED
  REJECTED
  REFUNDED
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
}

enum PayoutStatus {
  PENDING
  COMPLETED
}

enum TransactionType {
  CREDIT      // Money added to wallet
  DEBIT       // Money withdrawn from wallet
  WITHDRAWAL  // Merchant withdrawal
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
  FAILED
}

enum ApproveStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum TemplateCategory {
  PROMOTION
  ALERT
  UPDATE
  WELCOME
  VERIFICATION
  UTILITY
  TRANSACTIONAL
}

enum RecipientStatus {
  PENDING
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
  OPTED_OUT
}

enum CustomerStatus {  
  ACTIVE  
  INACTIVE  
  BLOCKED  
  ARCHIVED
}

enum CustomerType {  
  REGULAR  
  VIP  
  PREMIUM  
  WHOLESALE  
  BUSINESS
}

enum CustomerTier {  
  BRONZE  
  SILVER  
  GOLD  
  PLATINUM  
  DIAMOND
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  FAILED
  CANCELLED
}

enum DeliveryProvider {
  IN_HOUSE
  GIG_LOGISTICS
  DHL
}

enum RiderStatus {
  OFFLINE
  AVAILABLE
  BUSY
}