// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url     = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      Role     @default(MERCHANT)
  isActive  Boolean  @default(true)
  invitedBy String?
  joinedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Two-factor authentication fields
  twoFactorEnabled    Boolean  @default(false)
  twoFactorSecret     String?

  merchant      Merchant?
  preferences   UserPreferences?
  activityLogs  ActivityLog[]

  @@map("users")
}

model Merchant {
  id                   String             @id @default(cuid())
  userId               String             @unique
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade) 
  businessName         String
  category             String
  location             String
  phone                String
  profilePictureUrl    String?
  verificationStatus   VerificationStatus @default(PENDING)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  verification         MerchantVerification?

  products             Product[]
  orders               Order[]

  @@map("merchants")
}

model MerchantVerification {
  id                    String   @id @default(cuid())
  merchantId            String   @unique
  merchant              Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  governmentIdUrl       String
  businessLicenseUrl    String?
  productSampleUrl      String
  businessAddress       String
  registrationNumber    String?
  
  status                VerificationStatus @default(PENDING)
  rejectionReason       String?
  submittedAt           DateTime           @default(now())
  reviewedAt            DateTime?
  reviewedBy            String?
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  @@map("merchant_verifications")
}

model Product {
  id              String            @id @default(cuid())
  merchantId      String
  merchant        Merchant          @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  name            String
  description     String
  category        String
  price           Float
  stockQuantity   Int
  unit            String
  minOrderQty     Int
  
  images          String[]
  variants        Json?
  
  approvalStatus  ApprovalStatus    @default(PENDING)
  rejectionReason String?
  isActive        Boolean           @default(true)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  orderItems      OrderItem[]

  @@map("products")
}

model Order {
  id              String        @id @default(cuid())
  merchantId      String
  merchant        Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  orderItems      OrderItem[]
  
  totalAmount     Float
  status          OrderStatus   @default(PENDING)
  pickupTime      DateTime
  orderNotes      String?
  rejectionReason String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  quantity    Int
  price       Float
  
  createdAt   DateTime @default(now())

  @@map("order_items")
}

model StockUpdateNotification {
  id          String   @id @default(cuid())
  merchantId  String
  productId   String
  productName String
  oldStock    Int
  newStock    Int
  isRecieved  Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@map("stock_update_notifications")
}

model UserPreferences {
  id                  String  @id @default(cuid())
  userId              String  @unique
  user                User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  emailNotifications  Boolean @default(true)
  pushNotifications   Boolean @default(false)
  theme               String  @default("light")
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("user_preferences")
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action      String
  description String?
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())

  @@map("activity_logs")
  @@index([userId, createdAt])
}

enum Role {
  ADMIN
  MERCHANT
  MANAGER
  SUPPORT
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  PENDING
  ACCEPTED
  READY
  COMPLETED
  REJECTED
}