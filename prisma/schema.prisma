// This is your Prisma schema file,

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url     = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      Role     @default(MERCHANT)
  isActive  Boolean  @default(true)
  invitedBy String?
  joinedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inviteToken         String?   @unique
  inviteTokenExpiry   DateTime?

  // Two-factor authentication fields
  twoFactorEnabled    Boolean  @default(false)
  twoFactorSecret     String?

  merchant      Merchant?
  preferences   UserPreferences?
  activityLogs  ActivityLog[]

  @@map("users")
}

model Merchant {
  id                   String             @id @default(cuid())
  userId               String             @unique
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade) 
  businessName         String
  category             String
  location             String
  phone                String
  profilePictureUrl    String?
  verificationStatus   VerificationStatus @default(PENDING)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  verification         MerchantVerification?

  products             Product[]
  orders               Order[]

  @@map("merchants")
}

model MerchantVerification {
  id                    String             @id @default(cuid())
  merchantId            String             @unique
  merchant              Merchant           @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  governmentIdUrl       String
  businessLicenseUrl    String?
  productSampleUrl      String
  businessAddress       String
  registrationNumber    String?
  
  status                VerificationStatus @default(PENDING)
  
  idVerificationStatus       VerificationStatus @default(PENDING)
  locationVerificationStatus VerificationStatus @default(PENDING)
  productSampleStatus        VerificationStatus @default(PENDING)
  
  businessLicenseStatus      VerificationStatus?
  registrationNumberStatus   VerificationStatus?
  
  idVerifiedAt               DateTime?
  locationVerifiedAt         DateTime?
  productSampleVerifiedAt    DateTime?
  businessLicenseVerifiedAt  DateTime?
  registrationNumberVerifiedAt DateTime?
  
  idRejectionReason          String?
  locationRejectionReason    String?
  productRejectionReason     String?
  businessLicenseRejectionReason String?
  registrationNumberRejectionReason String?
  
  rejectionReason       String?
  submittedAt           DateTime           @default(now())
  reviewedAt            DateTime?
  reviewedBy            String?
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  @@map("merchant_verifications")
}

model Product {
  id              String            @id @default(cuid())
  merchantId      String
  merchant        Merchant          @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  name            String
  description     String
  category        String
  price           Float
  stockQuantity   Int
  unit            String
  minOrderQty     Int
  
  images          String[]
  variants        Json?

  markup          Float? @default(0)
  retailPrice     Float?
  
  approvalStatus  ApprovalStatus    @default(PENDING)
  rejectionReason String?
  isActive        Boolean           @default(true)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  whatsappProductId       String?
  whatsappSyncStatus      SyncStatus @default(NOT_SYNCED)
  lastSyncedAt            DateTime?

  orderItems            OrderItem[]
  customerOrderItems    CustomerOrderItem[]    @relation("ProductToCustomerOrderItem")
  cartItems             CartItem[]               @relation("ProductToCartItem")

  @@map("products")
}

model Order {
  id              String        @id @default(cuid())
  merchantId      String
  merchant        Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  
  orderItems      OrderItem[]
  
  totalAmount     Float
  status          OrderStatus   @default(PENDING)
  pickupTime      DateTime
  orderNotes      String?
  rejectionReason String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  quantity    Int
  price       Float
  
  createdAt   DateTime @default(now())

  @@map("order_items")
}

model StockUpdateNotification {
  id          String   @id @default(cuid())
  merchantId  String
  productId   String
  productName String
  oldStock    Int
  newStock    Int
  isRecieved  Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@map("stock_update_notifications")
}

model UserPreferences {
  id                  String  @id @default(cuid())
  userId              String  @unique
  user                User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  emailNotifications  Boolean @default(true)
  pushNotifications   Boolean @default(false)
  // theme               String  @default("light")
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("user_preferences")
}

model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action      String
  description String?
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())

  @@map("activity_logs")
  @@index([userId, createdAt])
}

model CustomerMessage {
  id              String    @id @default(cuid())
  messageId       String    @unique //whatsapp message 
  from            String    // customer phone number
  message         String    @db.Text
  timestamp       DateTime  @default(now())
  isRead          Boolean   @default(false)
  createdAt       DateTime  @default(now())

  @@map("customer_message")
}

model CustomerOrder {
  id              String              @id @default(cuid())
  orderNumber     String              @unique
  customerPhone   String
  customerName    String?
  customerEmail   String?             // Add email for Paystack
  totalAmount     Float
  status          CustomerOrderStatus @default(PENDING)
  paymentStatus   PaymentStatus       @default(PENDING)
  paymentReference String?            @unique // Paystack reference
  paymentProof    String?
  items           CustomerOrderItem[]
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  emailCollectionStatus String? // 'PENDING', 'COLLECTED', 'SKIPPED'
  pendingEmailCollection Boolean @default(false)

  invoice         Invoice?
  paymentExpiresAt    DateTime?
  
  @@map("customer_orders")
}

model CustomerOrderItem {
  id              String        @id @default(cuid())
  orderId         String
  order           CustomerOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId       String
  product         Product       @relation("ProductToCustomerOrderItem", fields: [productId], references: [id])
  quantity        Int
  price           Float
  
  @@map("customer_order_items")
}

model Cart {
  id            String    @id @default(cuid())
  customerPhone String
  items         CartItem[]
  status        CartStatus    @default(ACTIVE)
  expiresAt     DateTime   // Auto Expires after ceratin time
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("carts")
  @@index([customerPhone, status])
}

model CartItem {
  id          String   @id @default(cuid())
  cartId      String
  cart        Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation("ProductToCartItem", fields: [productId], references: [id])
  quantity    Int
  addedAt     DateTime @default(now())
  
  @@map("cart_items")
}

model Invoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique
  orderId         String   @unique
  order           CustomerOrder @relation(fields: [orderId], references: [id])
  pdfUrl          String?
  createdAt       DateTime @default(now())
}

enum Role {
  ADMIN
  MERCHANT
  MANAGER
  SUPPORT
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OrderStatus {
  PENDING
  ACCEPTED
  READY
  COMPLETED
  REJECTED
}

enum SyncStatus {
  NOT_SYNCED
  SYNCED
  FAILED
}

enum CustomerOrderStatus {
  PENDING
  PAYMENT_PENDING
  PAID 
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum CartStatus {
  ACTIVE
  ABANDONED
  CONVERTED
  EXPIRED
}